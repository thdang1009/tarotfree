---
import Layout from '../../layouts/Layout.astro';
import { detectLanguage, createTranslator } from '../../utils/i18nServer';
import { loadSpreads, loadCards } from '../../utils/loadData';
import { withLang } from '../../utils/linkHelper';
import FullReadingDisplay from '../../components/FullReadingDisplay';
import SpreadLayout from '../../components/SpreadLayout';

export const prerender = false;

// Detect language
const lang = detectLanguage(Astro.request);

// Create translator for this page
const t = createTranslator(lang, 'common');
const tReading = createTranslator(lang, 'readings');

// Parse URL params: /result/3-card/1-2-3/010?question=...
const params = Astro.params.params || '';
const [spreadId, cardIdsStr, reversedStr] = params.split('/');
const question = Astro.url.searchParams.get('question') || '';

const cardIds = cardIdsStr?.split('-').map(id => parseInt(id)) || [];

// Load language-specific spreads and cards
const spreads = loadSpreads(lang);
const spread = spreads.find(s => s.id === spreadId);
const cardsData = loadCards(lang);

if (!spread || cardIds.length !== spread.cardCount) {
  return Astro.redirect('/');
}

// Build the reading
const reading = cardIds.map((cardId, index) => {
  const card = cardsData[cardId];
  const reversed = reversedStr?.[index] === '1';
  const position = spread.positions[index];

  return {
    card,
    reversed,
    position,
  };
});

// Prepare drawn cards for Full Reading
const drawnCards = reading.map((item, index) => ({
  card: item.card,
  position: index + 1,
  reversed: item.reversed
}));

// Prepare selected cards for SpreadLayout (must match SelectedCard interface)
const selectedCards = cardIds.map((cardId, index) => ({
  cardId: cardId,
  reversed: reversedStr?.[index] === '1',
  position: index + 1
}));
---

<Layout
  title={t('messages.yourReadingTitle').replace('{spreadName}', spread.name)}
  description={t('messages.readingResultDesc')}
  noindex={true}
>
  <div class="container mx-auto px-4 py-12">
    <!-- Header with Compact Spread Preview -->
    <div class="text-center mb-5">
      <h1 class="text-4xl font-bold mb-2 text-violet-deep">
        {t('labels.yourReading')}: {spread.name}
      </h1>
      {question && (
        <p class="text-lg text-gray-700 italic mb-4">
          "{question}"
        </p>
      )}

      <!-- Compact Spread Preview -->
      <div class="max-w-3xl mx-auto mt-8 mb-0">
        <div class="bg-gradient-to-br from-violet-50 to-purple-50 rounded-2xl p-4 md:p-6 shadow-lg border-2 border-violet-200 transform scale-90 md:scale-100 origin-top">
          <SpreadLayout
            spread={spread}
            selectedCards={selectedCards}
            cardsData={cardsData}
            client:load
          />
        </div>
      </div>
    </div>

    <!-- Full Reading Section - FIRST -->
    <div class="max-w-5xl mx-auto mb-16">
      <FullReadingDisplay
        cards={drawnCards}
        spread={spread}
        question={question}
        client:load
      />
    </div>

    <!-- Individual Cards Section Heading -->
    <div class="max-w-4xl mx-auto mb-8">
      <h2 class="text-3xl font-heading text-violet-deep text-center mb-4">
        ğŸ“‡ Individual Card Meanings
      </h2>
      <p class="text-center text-gray-600">
        Explore each card's detailed interpretation based on its position
      </p>
    </div>

    <!-- Cards Display - SECOND -->
    <div class="max-w-4xl mx-auto space-y-8">
      {reading.map((item, index) => (
        <div class="bg-white rounded-lg shadow-lg p-6 animate-fade-in" style={`animation-delay: ${index * 0.2}s`}>
          <!-- Position Info -->
          <div class="border-b pb-3 mb-4">
            <h2 class="text-xl font-heading text-violet-deep">
              {t('labels.position')} {item.position.position}: {item.position.name}
            </h2>
            <p class="text-sm text-gray-600 mt-1">
              {item.position.description}
            </p>
          </div>

          <!-- Card Info -->
          <div class="flex flex-col md:flex-row gap-6">
            <!-- Card Image -->
            <div class="md:w-48 flex-shrink-0">
              <div class={`aspect-[2/3] rounded-lg overflow-hidden shadow-lg ${item.reversed ? 'rotate-180' : ''}`}>
                <img
                  src={item.card.image}
                  alt={item.card.name}
                  class="w-full h-full object-cover"
                />
              </div>
              {item.reversed && (
                <p class="text-center text-sm text-red-600 mt-2 font-bold">
                  âš ï¸ {t('labels.reversed')}
                </p>
              )}
            </div>

            <!-- Card Meaning -->
            <div class="flex-1">
              <h3 class="text-2xl font-heading text-violet-medium mb-2">
                {item.card.name}
                {item.reversed && <span class="text-red-600 text-lg ml-2">({t('labels.reversed')})</span>}
              </h3>

              <div class="mb-3">
                <span class="text-sm text-gray-500">{t('labels.keywords')}: </span>
                <span class="text-sm text-violet-deep">
                  {item.card.keywords.join(', ')}
                </span>
              </div>

              <!-- Quick Meaning -->
              <div class="bg-violet-light bg-opacity-10 p-4 rounded-lg mb-4">
                <p class="text-gray-800">
                  {item.reversed ? item.card.reversed.short : item.card.upright.short}
                </p>
              </div>

              <!-- Detailed Meanings -->
              <details class="mb-2">
                <summary class="cursor-pointer font-semibold text-violet-deep hover:text-gold-soft transition-colors mb-2">
                  ğŸ“– {t('labels.detailedInterpretation')}
                </summary>
                <div class="pl-4 space-y-3 text-sm text-gray-700">
                  <div>
                    <strong class="text-violet-medium">{t('labels.general')}:</strong>
                    <p>{item.reversed ? item.card.reversed.general : item.card.upright.general}</p>
                  </div>
                  {(item.reversed ? item.card.reversed.work : item.card.upright.work) && (
                    <div>
                      <strong class="text-violet-medium">ğŸ’¼ {t('labels.workCareer')}:</strong>
                      <p>{item.reversed ? item.card.reversed.work : item.card.upright.work}</p>
                    </div>
                  )}
                  {(item.reversed ? item.card.reversed.love : item.card.upright.love) && (
                    <div>
                      <strong class="text-violet-medium">â¤ï¸ {t('labels.loveRelationships')}:</strong>
                      <p>{item.reversed ? item.card.reversed.love : item.card.upright.love}</p>
                    </div>
                  )}
                  {(item.reversed ? item.card.reversed.health : item.card.upright.health) && (
                    <div>
                      <strong class="text-violet-medium">ğŸ¥ {t('labels.health')}:</strong>
                      <p>{item.reversed ? item.card.reversed.health : item.card.upright.health}</p>
                    </div>
                  )}
                  {(item.reversed ? item.card.reversed.spirituality : item.card.upright.spirituality) && (
                    <div>
                      <strong class="text-violet-medium">âœ¨ {t('labels.spirituality')}:</strong>
                      <p>{item.reversed ? item.card.reversed.spirituality : item.card.upright.spirituality}</p>
                    </div>
                  )}
                </div>
              </details>
            </div>
          </div>
        </div>
      ))}
    </div>

    <!-- Summary Section -->
    <div class="max-w-4xl mx-auto mt-12">
      <div class="bg-gradient-to-r from-violet-deep to-violet-medium text-white rounded-lg p-6 text-center">
        <h2 class="text-2xl font-heading mb-3">âœ¨ {t('labels.reflection')}</h2>
        <p class="text-lg italic">
          "{t('messages.reflectionQuote')}"
        </p>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="max-w-4xl mx-auto mt-8 flex flex-wrap justify-center gap-4">
      <button
        id="share-btn"
        class="px-6 py-3 bg-gold-soft text-white rounded-lg hover:bg-gold-light transition-colors"
      >
        ğŸ”— {t('buttons.share')}
      </button>
      <button
        id="download-btn"
        class="px-6 py-3 bg-violet-medium text-white rounded-lg hover:bg-violet-deep transition-colors"
      >
        ğŸ“¥ {t('buttons.export')}
      </button>
      <a
        href={withLang('/', lang)}
        class="px-6 py-3 bg-white border-2 border-violet-medium text-violet-medium rounded-lg hover:bg-violet-medium hover:text-white transition-all"
      >
        ğŸ´ {t('buttons.newReading')}
      </a>
    </div>

    <!-- Card Library Link -->
    <div class="text-center mt-8">
      <a href={withLang('/cards', lang)} class="text-violet-medium hover:text-gold-soft transition-colors">
        ğŸ“š {t('labels.browseAllCards')} â†’
      </a>
    </div>
  </div>

  <!-- Client-side Scripts -->
  <script define:vars={{ lang, t_linkCopied: t('labels.linkCopied'), t_imageExportSoon: t('messages.imageExportSoon') }}>
    // Share functionality
    const shareBtn = document.getElementById('share-btn');
    if (shareBtn) {
      shareBtn.addEventListener('click', () => {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
          const originalText = shareBtn.textContent;
          shareBtn.textContent = `âœ… ${t_linkCopied}`;
          setTimeout(() => {
            shareBtn.textContent = originalText;
          }, 2000);
        });
      });
    }

    // Download functionality (placeholder)
    const downloadBtn = document.getElementById('download-btn');
    if (downloadBtn) {
      downloadBtn.addEventListener('click', async () => {
        alert(t_imageExportSoon);
        // TODO: Implement html2canvas functionality
      });
    }
  </script>
</Layout>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fadeIn 0.6s ease-out forwards;
    opacity: 0;
  }

  details summary::-webkit-details-marker {
    display: none;
  }

  details summary::marker {
    display: none;
  }

  details summary {
    list-style: none;
  }

  details[open] summary {
    margin-bottom: 0.5rem;
  }
</style>
